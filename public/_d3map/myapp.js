var minZoom,maxZoom,countriesGroup,circleGroup,isOutOfViewport=function(t){var t=jQuery(t)[0].getBoundingClientRect(),e={};return e.top=t.top<0,e.left=t.left<0,e.bottom=t.bottom>(window.innerHeight||document.documentElement.clientHeight),e.right=t.right>(window.innerWidth||document.documentElement.clientWidth),e.any=e.top||e.left||e.bottom||e.right,e.all=e.top&&e.left&&e.bottom&&e.right,e.rightPx=t.right-window.innerWidth,e.bottomPx=t.bottom-window.innerHeight,e},tooltipIsOpen=!1,tooltipIsPositioned=!1,w=960,h=540,currentZoom=1,allLocations=[],path=(projection=d3.geoMercator().center([10,51]).scale(2300).translate([w/2,h/2]),d3.geoPath().projection(projection)),zoom=d3.zoom().on("zoom",zoomed),mapHolder=jQuery("#map-holder"),svg=d3.select("#map-holder").append("svg").attr("width",mapHolder.width()).attr("height",mapHolder.height()).call(zoom),jqsvg=jQuery("svg"),select2Options={allowClear:!1,templateResult:getColorForSelect2Option,templateSelection:getColorForSelect2Option,minimumResultsForSearch:-1},gradient_colors=["#E4002C","#005590","#F18700"],grad_red_blue=svg.append("defs").append("linearGradient").attr("id","grad_red_blue").attr("x1","0%").attr("x2","0%").attr("y1","100%").attr("y2","0%"),grad_blue_orange=(grad_red_blue.append("stop").attr("offset","50%").style("stop-color",gradient_colors[0]),grad_red_blue.append("stop").attr("offset","50%").style("stop-color",gradient_colors[1]),svg.append("defs").append("linearGradient").attr("id","grad_blue_orange").attr("x1","0%").attr("x2","0%").attr("y1","100%").attr("y2","0%")),grad_red_orange=(grad_blue_orange.append("stop").attr("offset","50%").style("stop-color",gradient_colors[1]),grad_blue_orange.append("stop").attr("offset","50%").style("stop-color",gradient_colors[2]),svg.append("defs").append("linearGradient").attr("id","grad_red_orange").attr("x1","0%").attr("x2","0%").attr("y1","100%").attr("y2","0%")),grad_red_blue_orange=(grad_red_orange.append("stop").attr("offset","50%").style("stop-color",gradient_colors[0]),grad_red_orange.append("stop").attr("offset","50%").style("stop-color",gradient_colors[2]),svg.append("defs").append("linearGradient").attr("id","grad_red_blue_orange").attr("x1","0%").attr("x2","0%").attr("y1","100%").attr("y2","0%"));function getColorForSelect2Option(t){var e="",o="hidden";switch(t.id){case"JMD":e=gradient_colors[1];break;case"Respekt Coaches":e=gradient_colors[2];break;case"JMD-iQ":e=gradient_colors[0]}return""!==e&&(o=""),$("<div class='select2_custom_option'><div class='select_circle "+o+"' style='background-color: "+e+"'></div><div class='select_text'>"+t.text+"</div></div>")}function refreshSelect2Elements(t){jQuery(t).select2(select2Options)}function zoomed(){tooltipIsOpen&&hideTooltip();var t=d3.event.transform,e=(countriesGroup.attr("transform","translate("+[t.x,t.y]+")scale("+t.k+")"),circleGroup.attr("transform","translate("+[t.x,t.y]+")scale("+t.k+")"),6/d3.event.transform.k+.6*t.k);svg.selectAll("circle").attr("d",path.projection(projection)).attr("r",e),currentZoom=t.k,d3.event.transform.k===minZoom&&"Alle"!==document.getElementById("State").value&&($("#State").val("Alle"),$("#State").trigger("change"))}function getTextBox(t){t.each(function(t){t.bbox=this.getBBox()})}function removeSpecialCharacters(t){return t=t.replace(/\s/g,"")}function initiateZoom(){minZoom=Math.max(mapHolder.width()/w,mapHolder.height()/h),maxZoom=3.5,zoom.scaleExtent([minZoom,maxZoom]).translateExtent([[0,0],[w,h]]);var t=(mapHolder.width()-minZoom*w)/2,e=(mapHolder.height()-minZoom*h)/2;svg.call(zoom.transform,d3.zoomIdentity.translate(t,e).scale(minZoom))}function boxZoom(t,e,o,a){hideTooltip(),showLocationsInList("",a.NAME_1),$("select#State").val(a.NAME_1);var a=t[0],t=t[1],r=Math.abs(a[0]-t[0]),a=Math.abs(a[1]-t[1]),t=e[0],e=e[1],o=(r*=1+o/100,a*=1+o/100,jqsvg.width()/r),r=jqsvg.height()/a,a=Math.min(o,r),a=Math.min(a,maxZoom),o=(a=Math.max(a,minZoom))*t,r=a*e,t=Math.min(0,jqsvg.width()/2-o),e=Math.min(0,jqsvg.height()/2-r),t=Math.max(jqsvg.width()-w*a,t),e=Math.max(jqsvg.height()-h*a,e);svg.transition().duration(400).call(zoom.transform,d3.zoomIdentity.translate(t,e).scale(a)).on("end",function(){hideTooltip()})}function getCircleColor(t){var e="#005590";if(void 0!==t.Tag){for(var o=[],a=0;a<t.Tag.length;a++)o.push(t.Tag[a].LocationsTag.tag_id);switch(o.join("-")){case"5":e=gradient_colors[1];break;case"6":e=gradient_colors[0];break;case"7":e=gradient_colors[2];break;case"5-6":case"6-5":e="url(#grad_red_blue)";break;case"7-5":case"5-7":e="url(#grad_blue_orange)";break;case"6-7":case"7-7":e="url(#grad_red_orange)";break;case"5-7-6":case"5-6-7":case"7-6-5":e="url(#grad_red_blue_orange)"}}return e}function selectState(){var t=document.getElementById("State").value;"Alle"!==t?document.getElementById("country"+t).dispatchEvent(new Event("click")):(countriesGroup.selectAll(".country-on").classed("country-on",!1),zoom.scaleBy(svg.transition().duration(250),0)),""===t&&(t="All"),hideTooltip(),showLocationsInList("",t)}function selectTag(){var t;"Alle"!==(t=removeSpecialCharacters(document.getElementById("Tags").value))?(jQuery("circle.country_circle").hide(),jQuery("circle.country_circle[data-tags*='"+t+"']").show()):jQuery("circle.country_circle").show(),hideTooltip(),showLocationsInList(t,"")}function showLocationsForState(t,e){inactivateAllCircles();var o=[];if("Alle"!==t){circleGroup.selectAll("circle").remove();for(var a=0;a<e.length;a++)e[a].Location.federal_state===t&&o.push(e[a])}else o=e;circleGroup.selectAll("circle").data(o).enter().append("svg:circle").style("fill",function(t){return getCircleColor(t)}).attr("class","country_circle").attr("cx",t=>projection([t.Location.longitude,t.Location.latitude])[0]).attr("cy",t=>projection([t.Location.longitude,t.Location.latitude])[1]).attr("r",5).attr("data-tags",function(t,e){var o="";if(void 0!==t.Tag)for(var a=0;a<t.Tag.length;a++)o+=removeSpecialCharacters(t.Tag[a].name)+" ";return o}).attr("data-state",function(t,e){return t.Location.federal_state}).on("click",function(t,e){}).on("mouseover",function(t,e){var o,a;showTooltip(t),showCountryName(!1),d3.select(this).attr("class","active country_circle zoom_level_"+Math.round(currentZoom)),tooltipIsPositioned||(t=d3.event.pageX+10,a=d3.event.pageY+10,d3.select("#global_tooltip").style("left",t+"px").style("top",a+"px"),!0===(o=isOutOfViewport(jQuery("div#global_tooltip"))).any&&(o.bottom&&(a=a-(o.bottomPx+40),d3.select("#global_tooltip").style("top",a+"px")),o.right&&(a=t-(o.rightPx+40),d3.select("#global_tooltip").style("left",a+"px"))),tooltipIsPositioned=!0)}).on("mouseout",function(t,e){showCountryName(!0),tooltipIsPositioned=!1}).on("mousemove",function(){})}function showLocationsInList(t="",e=""){var o=[];""!==e&&showLocationsForState(e,allLocations);for(var a=0;a<allLocations.length;a++)if(""!==e)allLocations[a].Location.federal_state===e&&o.push({ID:allLocations[a].Location.id,Name:allLocations[a].Location.name});else if(""!==t)for(var r=0;r<allLocations[a].Tag.length;r++)allLocations[a].Tag[r].name===t&&o.push({ID:allLocations[a].Location.id,Name:allLocations[a].Location.name});jQuery("#location_list_view").html('<li><a href="openlocation.php" class="bind-ID" target="_blank"><span class="bind-Name"></span></a></li>'),jQuery("#location_list_view li").view(o)}function setCountryName(t){jQuery("#countryName").html("<span>"+t+"</span>")}function showCountryName(t){t?jQuery("#countryName").show():jQuery("#countryName").hide()}function showTooltip(t){inactivateAllCircles();var e="";if(void 0!==t.Tag)for(var o=0;o<t.Tag.length;o++)e+=t.Tag[o].name+"<br/>";var a="",a=(t.Location.phone&&(a=t.Location.phone+"<br/>"),{tooltip_headline:t.Location.name,tooltip_city:t.Location.plz+" "+t.Location.city,tooltip_street:t.Location.street,tooltip_state:t.Location.federal_state,tooltip_phone:a,tooltip_tags:e,ID:t.Location.id});jQuery("div#global_tooltip").view(a),jQuery("#global_tooltip").stop().css("display","block"),tooltipIsOpen=!0}function hideTooltip(){tooltipIsOpen&&(tooltipIsOpen=!1,jQuery("#global_tooltip").stop().css("display","none"),inactivateAllCircles())}function inactivateAllCircles(){jQuery("circle.active").removeClass("active")}function drawMap(t,e,o){allLocations=o.locations,(countriesGroup=svg.append("g").attr("id","map")).append("rect").attr("x",0).attr("y",0).attr("width",w).attr("height",h),countriesGroup.selectAll("path").data(e.features).enter().append("path").attr("d",path).attr("id",function(t,e){return"country"+t.properties.NAME_1}).attr("class","country").on("mouseover",function(t,e){d3.select("#countryLabel"+t.properties.NAME_1).style("display","block"),setCountryName(t.properties.NAME_1),showCountryName(!0)}).on("mouseout",function(t,e){d3.select("#countryLabel"+t.properties.NAME_1).style("display","none"),showCountryName(!1)}).on("click",function(t,e){d3.selectAll(".country").classed("country-on",!1),d3.select(this).classed("country-on",!0),boxZoom(path.bounds(t),path.centroid(t),20,t.properties),$("#State").select2("destroy"),$("#State").val(t.properties.NAME_1).select2(select2Options)}).on("mousedown",function(){hideTooltip()}).on("mousemove",function(){var t=d3.event.pageX,e=d3.event.pageY;d3.select("#countryName").style("left",t+10+"px").style("top",e+10+"px")}),circleGroup=svg.append("g").attr("id","circles");var a=[];a.push("Alle");for(var r=0;r<e.features.length;r++)a.push(e.features[r].properties.NAME_1);jQuery("#State").view(a),refreshSelect2Elements("#State");for(var n=0;n<e.features.length;n++){for(var i=0,l=e.features[n].properties.NAME_1,s=0;s<allLocations.length;s++)allLocations[s].Location.federal_state===l&&i++;jQuery('#State option[value="'+l+'"]').text(l),0===i&&($("#list>optgroup>option[value='1']").attr("disabled","disabled"),jQuery('#State option[value="'+l+'"]').attr("disabled","disabled"),countriesGroup.selectAll("#country"+l).attr("class","country-disabled"))}jQuery('#State option[value="Alle"]').text("Alle");showLocationsForState("Alle",allLocations),$("#State").val("Alle").trigger("click");for(var c=[],d=(c.push("Alle"),[]),p=0;p<o.locations.length;p++)if(void 0!==o.locations[p].Tag)for(var i=0,u=0;u<o.locations[p].Tag.length;u++){var g=o.locations[p].Tag[u].name;d.hasOwnProperty(g)||(d[g]=0),d[g]+=1,c.includes(g)||c.push(g)}if(1<c.length){for(var l in jQuery("#Tags").view(c),refreshSelect2Elements("#Tags"),d){d[l];jQuery('#Tags option[value="'+l+'"]').text(l)}jQuery('#Tags option[value="Alle"]').text("Alle")}else jQuery("#Tags").hide(),jQuery(".label_tags").hide();initiateZoom()}grad_red_blue_orange.append("stop").attr("offset","25%").style("stop-color",gradient_colors[0]),grad_red_blue_orange.append("stop").attr("offset","50%").style("stop-color",gradient_colors[1]),grad_red_blue_orange.append("stop").attr("offset","75%").style("stop-color",gradient_colors[2]),jQuery(window).resize(function(){svg.attr("width",jQuery(mapHolder).width()).attr("height",jQuery(mapHolder).height()),initiateZoom(),tooltipIsOpen&&hideTooltip()}),jQuery(document).add(parent.document).mouseup(function(t){tooltipIsOpen&&hideTooltip()}),queue().defer(d3.json,"./json/dataBundesLander.json").defer(d3.json,"./json_proxy.php?nav_id=14").await(drawMap),d3.select("#button_zoom_in").on("click",function(){zoom.scaleBy(svg.transition().duration(250),1.6),hideTooltip()}),d3.select("#button_zoom_out").on("click",function(){zoom.scaleBy(svg.transition().duration(250),.4),hideTooltip()});